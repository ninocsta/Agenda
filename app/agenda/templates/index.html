{% extends "base.html" %}



{% block content %}
<!-- jQuery -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>
<script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>

<!-- jQuery UI -->
<script src="https://code.jquery.com/ui/1.12.1/jquery-ui.min.js"></script>
<script src="https://code.jquery.com/ui/1.11.3/jquery-ui.min.js"></script>

<!-- Moment.js -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.14.1/moment.min.js"></script>

<!-- Bootstrap CSS/JS -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.1/dist/css/bootstrap.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.1/dist/js/bootstrap.bundle.min.js"></script>

<!-- Bootstrap-Select CSS/JS -->
<link rel="stylesheet"
  href="https://cdn.jsdelivr.net/npm/bootstrap-select@1.14.0-beta2/dist/css/bootstrap-select.min.css">
<script src="https://cdn.jsdelivr.net/npm/bootstrap-select@1.14.0-beta2/dist/js/bootstrap-select.min.js"></script>


<!-- FullCalendar JS -->
<script src='https://cdn.jsdelivr.net/npm/fullcalendar-scheduler@6.1.11/index.global.min.js'></script>

<!--Sweet Alert -->
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>


<!-- momentr tz -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/moment-timezone/0.5.33/moment-timezone-with-data.min.js"></script>





<div class="col-md-12 col-10">
  <div id='calendar'></div>


  <!-- Criar Evento Modal -->
  <div class="modal fade" id="addEventModal" tabindex="-1" role="dialog" aria-labelledby="addEventModalLabel"
    aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h4 class="modal-title" id="addEventModalLabel">Adicionar Evento</h4>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <form name="Form" id="form" action="" data-funcoes-url="{% url 'ajax_load_funcoes' %}"
            data-dados-url="{% url 'ajax_load_dados' %}">
            {% csrf_token %}


            <div class="form-group">
              <label for="eventStart">Data</label>
              <input type="datetime-local" class="form-control" id="startDate" placeholder="Enter Start Date">
            </div>


            <div class="form-group">
              <label class="control-label" for="client">Cliente</label>
              <select class="selectpicker form-control" data-live-search="true" id="clientinput">
                <option value="">Selecione</option>
                {% for client in clientes %}
                <option value="{{ client.id }}">{{ client.name }} - {{ client.fone }}</option>
                {% endfor %}
              </select>
            </div>

            <div class="form-group">
              <label class="control-label" for="profissional_id">Profissional</label>
              <div>
                <select name="profissional_id" required id="profissional_id" class="form-control profissional_id">
                  <option value="">Selecione</option>
                  {% for profissional in profissionais %}
                  <option value="{{ profissional.id }}">
                    {{ profissional.name }}
                  </option>
                  {% endfor %}
                </select>
              </div>
            </div>

            <div class="form-group">
              <label class="control-label" for="servico_id">Serviço</label>
              <div>
                <select name="servico_id" required id="servico_id" class="form-control servico_id">
                  <option value="">Selecione</option>
                  {% for servico in servicos %}
                  <option value="{{ servico.id }}" data-time-min="{{ servico.time_min }}">{{ servico.description }}
                  </option>
                  {% endfor %}
                </select>
              </div>
            </div>

            <div class="form-group">
              <label class="control-label" for="servico_time_min">Duração (Minutos)</label>
              <input id="timeMinInput" type="text" class="form-control">
            </div>

            <div class="form-group">
              <label for="obs" class="control-label">Observação</label>
              <textarea name="obs" id="obs" class="form-control"></textarea>
            </div>
          </form>

        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-primary" id="addEventBtn">Adicionar</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Editar Modal -->
  <div class="modal fade" id="editEventModal" tabindex="-1" role="dialog" aria-labelledby="editEventModalLabel"
    aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h4 class="modal-title" id="addEventModalLabel">Editar Evento</h4>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <form name="Form" id="form" action="" data-funcoes-url="{% url 'ajax_load_funcoes' %}"
            data-dados-url="{% url 'ajax_load_dados' %}">
            {% csrf_token %}

            <div>
              <p class="event_id" id="event_id"></p>
            </div>

            <div class="form-group">
              <label for="eventStart">Data</label>
              <input type="datetime-local" class="form-control" id="editStartDate" placeholder="Enter Start Date">
            </div>


            <div class="form-group">
              <label class="control-label" for="editclientpicker">Cliente</label>
              <select class="selectpicker form-control" data-live-search="true" id="editclientpicker">
                <option value="">Selecione</option>
                {% for client in clientes %}
                <option value="{{ client.id }}">{{ client.name }} - {{ client.fone }}</option>
                {% endfor %}
              </select>
            </div>

            <div class="form-group">
              <label class="control-label" for="profissional_id">Profissional</label>
              <div>
                <select name="professional_id" required id="edit_profissional_id" class="form-control profissional_id">
                  <option value="">Selecione</option>
                  {% for profissional in profissionais %}
                  <option value="{{ profissional.id }}">
                    {{ profissional.name }}
                  </option>
                  {% endfor %}
                </select>
              </div>
            </div>

            <div class="form-group">
              <label class="control-label" for="servico_id">Serviço</label>
              <div>
                <select name="servico_id" required id="edit_servico_id" class="form-control servico_id">
                  <option value="">Selecione</option>
                  {% for servico in servicos %}
                  <option value="{{ servico.id }}" data-time-min="{{ servico.time_min }}">{{ servico.description }}
                  </option>
                  {% endfor %}
                </select>
              </div>
            </div>

            <div class="form-group">
              <label class="control-label" for="servico_time_min">Duração (Minutos)</label>
              <input id="edittimeMinInput" type="text" class="form-control">
            </div>

            <div class="form-group">
              <label for="obs" class="control-label">Observação</label>
              <textarea name="obs" id="edit_obs" class="form-control"></textarea>
            </div>
            <div class="form-group">
              <label class="control-label" for="edit_status">Status</label>
              <select class="selectpicker form-control" name="status" id="edit_status">
                {% for value, name in status_choices %}
                <option value="{{ value }}">{{ name }}</option>
                {% endfor %}
              </select>
            </div>
          </form>

        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-primary" id="editEventBtn">Confirmar</button>
        </div>
      </div>
    </div>
  </div>




  <!-- Success Modal -->
  <div class="modal fade" id="successModal" tabindex="-1" role="dialog" aria-labelledby="successModalLabel"
    aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered" role="document">
      <div class="modal-content">
        <div class="modal-body">
          <!-- Success message will be inserted here -->
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-primary" data-bs-dismiss="modal">Close</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Error Modal -->
  <div class="modal fade" id="errorModal" tabindex="-1" role="dialog" aria-labelledby="errorModalLabel"
    aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered" role="document">
      <div class="modal-content">
        <div class="modal-body">
          <!-- Error message will be inserted here -->
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-primary" data-bs-dismiss="modal">Close</button>
        </div>
      </div>
    </div>
  </div>


  <script>
    document.addEventListener('DOMContentLoaded', function () {
      var calendarEl = document.getElementById('calendar');
      var calendar = new FullCalendar.Calendar(calendarEl, {
        schedulerLicenseKey: 'CC-Attribution-NonCommercial-NoDerivatives',
        headerToolbar: {
          left: 'prev,next today',
          center: 'title',
          right: 'timeGridWeek,timeGridDay,listWeek'
        },
        // initialView: window.innerWidth < 650 ? 'timeGridDay' : 'timeGridWeek',
        initialView: 'resourceTimeGridDay',
        locale: 'pt-br',
        timeZone: 'America/Sao_Paulo',
        events: '/all_events',
        resources: '/all_resources',
        selectable: true,
        editable: true,
        longPressDelay: 80,
        height: 800,
        buttonText: {
          today: 'Hoje',
          month: 'Mês',
          week: 'Semana',
          day: 'Dia',
          list: 'Lista'
        },

        select: function (info) {
          $('#addEventModal').on('show.bs.modal', function () {
            // Set the initial values for start date
            var date = moment(info.startStr); // Create a moment object from the date string
            var formattedDate = date.format('YYYY-MM-DDTHH:mm'); // Format the date
            $('#startDate').val(formattedDate); // Use the formatted date
            $('#clientinput').val('');
            $('#clientinput').selectpicker('refresh');
            $('#profissional_id').val('');
            $('#servico_id').val('');
            $('#timeMinInput').val('');
            $('#obs').val('');

          });

          $('#addEventModal').modal('show');

          $('#addEventBtn').off('click').on('click', function () {
            var startDate = $('#startDate').val();
            var client = $('#clientinput').val();
            var profissional = $('#profissional_id').val();
            var servico = $('#servico_id').val();
            var obs = $('#obs').val();
            var timeMinInput = $('#timeMinInput').val();
            if (startDate && client && profissional && servico && timeMinInput) {
              $.ajax({
                type: "GET",
                url: '/add_event',
                data: { 'start': startDate, 'client': client, 'profissional': profissional, 'servico': servico, 'obs': obs, 'timeMin': timeMinInput },
                dataType: "json",
                success: function (data) {
                  calendar.refetchEvents();
                  Swal.fire({                    
                    text: "Criado com sucesso!",
                    icon: "success",
                    showConfirmButton: false,
                    timer: 1000
                  });
                },
                error: function (data) {
                  $('#successModal .modal-body').html('Erro');
                  $('#successModal').modal('show');
                }
              });
              $('#addEventModal').modal('hide');
            }
          });
        },

        // resize do evento 
        eventResize: function (info) {
          var startStr = moment.utc(info.event.start);
          var start = startStr.format('YYYY-MM-DDTHH:mm');
          var endStr = moment.utc(info.event.end);
          var end = endStr.format('YYYY-MM-DDTHH:mm');
          var id = info.event.id;
          $.ajax({
            type: "GET",
            url: '/move',
            data: { 'start': start, 'end': end, 'id': id },
            dataType: "json",
            success: function (data) {
              $('#successModal .modal-body').html('Alterado com sucesso!');
              $('#successModal').modal('show');
            },
            error: function (data) {
              $('#errorModal .modal-body').html('Erro');
              $('#errorModal').modal('show');
            }
          });
        },
        // mover evento
        eventDrop: function (info) {          
          var startStr = moment.utc(info.event.start);
          var start = startStr.format('YYYY-MM-DDTHH:mm');
          var endStr = moment.utc(info.event.end);
          var end = endStr.format('YYYY-MM-DDTHH:mm');
          var id = info.event.id;
          $.ajax({
            type: "GET",
            url: '/move',
            data: { 'start': start, 'end': end, 'id': id },
            dataType: "json",
            success: function (data) {
              $('#successModal .modal-body').html('Alterado com sucesso!');
              $('#successModal').modal('show');
            },
            error: function (data) {
              $('#errorModal .modal-body').html('Erro');
              $('#errorModal').modal('show');
            }
          });
        },
        // Editar evento
        eventClick: function (info) {
          $('#event_id').text(info.event.id);
          $('#editEventModal #editStartDate').val(info.event.startStr);
          var professionalElement = $(document.getElementsByClassName('profissional_id')[1]);
          professionalElement.val(info.event.extendedProps.professional_id);
          professionalElement.change();  // Dispara o evento de mudança manualmente 
          $('#edit_obs').val(info.event.extendedProps.observation);
          $('#edittimeMinInput').val(info.event.extendedProps.minutes);
          console.log('colocou o valor no edit')
          $('#editclientpicker').val(info.event.extendedProps.client_id);
          $('#edit_status').val(info.event.extendedProps.status);
          $('#edit_status, #editclientpicker').selectpicker('refresh');

          $('#editEventModal').modal('show');
          $('#editEventBtn').off('click').on('click', function () {
            var id = info.event.id;
            var startDate = $('#editStartDate').val();
            var client = $('#editclientpicker').val();
            var profissional = $('#edit_profissional_id').val();
            var servico = $('#edit_servico_id').val();
            var timeMinInput = $('#edittimeMinInput').val();
            var obs = $('#edit_obs').val();
            var status = $('#edit_status').val();

            $.ajax({
              type: "GET",
              url: '/update',
              data: { 'id': id, 'start': startDate, 'client': client, 'profissional': profissional, 'servico': servico, 'timeMin': timeMinInput, 'obs': obs, 'status': status },
              dataType: "json",
              success: function (data) {
                calendar.refetchEvents();
                $('#successModal .modal-body').html('Evento Atualizado!');
                $('#successModal').modal('show');
              },
              error: function (data) {
                $('#errorModal .modal-body').html('There is a problem!!!');
                $('#errorModal').modal('show');
              }
            });
            $('#editEventModal').modal('hide');
          });
          // }
        },

      });



      calendar.render();
    });

  </script>
  <!-- chamda dos serviços após selecionar o profissional-->
  <script type="text/javascript">


    $(".profissional_id, .edit_profissional_id").change(function () {
      var url = $("#form").attr("data-funcoes-url");
      var profissionalId = $(this).val();
      var event = $("#event_id").text();
      $.ajax({
        url: url,
        data: {
          'profissional_id': profissionalId,
          'event': event,
        },
        success: function (data) {
          // Clear the select options
          $("#servico_id, #edit_servico_id").empty();


          // Add new options to the select
          $.each(data, function (i, item) {
            var option = $('<option>', {
              value: item.id,
              text: item.description
            });

            // If this item is selected, add the 'selected' attribute to the option
            if (item.selected) {
              option.attr('selected', 'selected');
            }

            $('#servico_id, #edit_servico_id').append(option);
          });

          // Trigger the change event
          $("#servico_id").trigger('change');
        }
      });
    });

  </script>
  <!-- chamda do tempo do servico após selecionar o servico na criação-->
  <script type="text/javascript">
    $("#servico_id").change(function () {
      var url = $("#form").attr("data-dados-url");
      var servicoId = $(this).val();
      $.ajax({
        url: url,
        data: {
          'servico_id': servicoId
        },
        success: function (data) {
          $('#timeMinInput').val(data.time_min);

        }
      });
    });
  </script>
  <!-- chamda do tempo do servico após selecionar o servico na hora de editar-->
  <script type="text/javascript">
    $("#edit_servico_id").change(function () {
      var url = $("#form").attr("data-dados-url");
      var servicoId = $(this).val();
      $.ajax({
        url: url,
        data: {
          'servico_id': servicoId
        },
        success: function (data) {
          $('#edittimeMinInput').val(data.time_min);
        }
      });
    });
  </script>




  {% endblock content %}